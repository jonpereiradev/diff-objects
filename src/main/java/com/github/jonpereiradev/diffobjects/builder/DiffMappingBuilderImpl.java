package com.github.jonpereiradev.diffobjects.builder;


import com.github.jonpereiradev.diffobjects.comparator.DiffComparator;
import com.github.jonpereiradev.diffobjects.comparator.EqualsComparator;
import com.github.jonpereiradev.diffobjects.comparator.IndexComparator;
import com.github.jonpereiradev.diffobjects.strategy.DiffMetadata;
import com.github.jonpereiradev.diffobjects.strategy.DiffStrategyType;
import org.apache.commons.lang.StringUtils;

import java.lang.reflect.Method;
import java.util.Collection;
import java.util.Map;
import java.util.Objects;


/**
 * Responsible to map a class and fields to be able to generate diffs.
 *
 * @author Jonathan Pereira
 * @see DiffInstanceBuilder
 * @see DiffMappingBuilder
 * @see DiffConfiguration
 * @since 1.0
 */
final class DiffMappingBuilderImpl<T> implements DiffMappingBuilder<T> {

    private static final String REGEX_PROPERTY_SEPARATOR = "\\.";

    private final Class<T> classMap;
    private final Map<String, DiffMetadata> metadatas;

    DiffMappingBuilderImpl(Class<T> classMap, Map<String, DiffMetadata> metadatas) {
        this.classMap = classMap;
        this.metadatas = metadatas;
    }

    /**
     * Maps the getter of the field for the class.
     *
     * @param field name of the field that will me used to find the getter method.
     *
     * @return the instance of this mapping instance.
     */
    @Override
    public DiffQueryMappingBuilder<T> mapping(String field) {
        return mapping(field, null, new EqualsComparator<>());
    }

    /**
     * Maps the getter of the field for the class.
     *
     * @param field name of the field that will me used to find the getter method.
     * @param comparator implementation that define how two objects will be check for equality.
     *
     * @return the instance of this mapping.
     */
    @Override
    public <F> DiffQueryMappingBuilder<T> mapping(String field, Class<F> fieldClass, DiffComparator<F> comparator) {
        Objects.requireNonNull(field, "Field name is required.");

        String nestedField = StringUtils.EMPTY;
        String[] fields = field.split(REGEX_PROPERTY_SEPARATOR);
        Method method = DiffReflections.discoverGetter(classMap, fields[0]);
        DiffStrategyType diffStrategyType = DiffStrategyType.SINGLE;

        if (fields.length > 1) {
            diffStrategyType = DiffStrategyType.NESTED;
            nestedField = field.substring(field.indexOf(".") + 1);
        }

        if (Collection.class.isAssignableFrom(method.getReturnType())) {
            diffStrategyType = DiffStrategyType.COLLECTION;
        }

        DiffMetadata diffMetadata = new DiffMetadata(nestedField, method, diffStrategyType, comparator);
        diffMetadata.getProperties().put("field", field);

        metadatas.put(field, diffMetadata);

        return new DiffQueryMappingBuilderImpl<>(diffMetadata, this, metadatas);
    }

    /**
     * Maps the getter of the field for the class.
     *
     * @param fieldCollection name of the field that will me used to find the getter method.
     *
     * @return the instance of this mapping.
     */
    @Override
    public DiffMappingCollectionBuilder<T> mappingCollection(String fieldCollection) {
        return mappingCollection(fieldCollection, null, new IndexComparator<>());
    }

    /**
     * Maps the getter of the field for the class.
     *
     * @param fieldCollection name of the field that will me used to find the getter method.
     * @param elementClass implementation that define how two objects will be check for equality.
     * @param comparator
     *
     * @return the instance of this mapping.
     */
    @Override
    public <E> DiffMappingCollectionBuilder<T> mappingCollection(String fieldCollection, Class<E> elementClass, DiffComparator<E> comparator) {
        return new DiffMappingCollectionBuilderImpl<>(classMap, fieldCollection, comparator, metadatas);
    }

    /**
     * Gets the configuration instance to get the configuration generated by this instance instance.
     *
     * @return a configuration instance instance.
     */
    @Override
    public DiffConfiguration configuration() {
        return new DiffConfigurationImpl(metadatas);
    }
}
